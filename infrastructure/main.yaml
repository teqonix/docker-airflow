AWSTemplateFormatVersion: "2010-09-09"
Description: A stack that launches an Airflow instance using ECS, EC2, and RDS
Parameters:
  AvailabilityZone:
    Type: String
    Default: us-east-2
  AWSAccountNumber:
    Type: String
    Default: '386210534560'
  RDSMasterPassword:
    Type: String
  RDSInstanceType:
    Type: String
    Default: db.t2.micro
  LatestEcsAmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ecs/optimized-ami/amazon-linux-2/recommended/image_id
  EC2InstanceType:
    Type: String
    Default: t2.medium
  EC2KeyPairName:
    Type: String
  ECRNumberOfAllowedImages:
    Type: Number

Resources:
  #----------------------Shared Resources (Networking)----------------------#
  AirflowVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 172.16.0.0/16
      EnableDnsHostnames: True
      EnableDnsSupport: True

  AirflowVPCSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      CidrBlock: 172.16.0.0/28
      MapPublicIpOnLaunch: True
      VpcId: !Ref AirflowVPC
      AvailabilityZone: !Sub ${AvailabilityZone}a

  # Allow the VPC to connect to the internet:
  AirflowVPCGateway:
    Type: AWS::EC2::InternetGateway

  AirflowVPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref AirflowVPC
      InternetGatewayId: !Ref AirflowVPCGateway

  AirflowVPCSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Has the EC2 Instances and DB for Airflow in it
      GroupName: AirflowSecurityGroup
      VpcId: !Ref AirflowVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: 172.16.0.0/28
        - IpProtocol: tcp
          FromPort: 2049
          ToPort: 2049
          CidrIp: 172.16.0.0/28          
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIpv6: ::/0            

  AirflowVPCRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref AirflowVPC

  AirflowInternetRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref AirflowVPCRouteTable
      DestinationCidrBlock: 0.0.0.0/0 # Allow ingress from anywhere on the internet
      GatewayId: !Ref AirflowVPCGateway

  AirflowRouteSubnetAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties: 
      RouteTableId: !Ref AirflowVPCRouteTable
      SubnetId: !Ref AirflowVPCSubnet

  #----------------------Database----------------------#

        # Temporarily disabled to test EFS + IAM Role for EC2

  # AirflowDatabase:
  #   Type: AWS::RDS::DBInstance
  #   Properties:
  #     AllowMajorVersionUpgrade: False
  #     AutoMinorVersionUpgrade: True
  #     BackupRetentionPeriod: 7
  #     DBInstanceClass: !Sub ${RDSInstanceType}
  #     DBName: airflow
  #     DBSubnetGroupName: !Ref AirflowDBSubnet
  #     Engine: postgres
  #     MasterUsername: airflow
  #     MasterUserPassword: !Sub ${RDSMasterPassword}
  #     Port: "5432"
  #     StorageEncrypted: False
  #     StorageType: gp2
  #     VPCSecurityGroups:
  #       - !Ref AirflowVPCSecurityGroup
  #     AllocatedStorage: "30"

  # AirflowDBSubnet:
  #   Type: AWS::RDS::DBSubnetGroup
  #   Properties:
  #     DBSubnetGroupDescription: The subnet used by the Airflow cluster
  #     DBSubnetGroupName: AirflowDBSubnet
  #     SubnetIds:
  #       - !Ref AirflowVPCSubnet

  #-----------------------------Persistent Storage-----------------------#

  AirflowPersistantFileSystem:
    Type: AWS::EFS::FileSystem
    Properties:
      Encrypted: true
      PerformanceMode: generalPurpose
      ThroughputMode: bursting

  AirflowPersistantStorageMountTarget:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref AirflowPersistantFileSystem
      SecurityGroups:
        - !Ref AirflowVPCSecurityGroup
      SubnetId: !Ref AirflowVPCSubnet

  #---------------------- IAM Permissions for EC2 Instance ----------------------#      

  AirflowEC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
                - ecs.amazonaws.com
            Action:
              - sts:AssumeRole
      Description: 'Allows an EC2 Instance Access to the Airflow EFS Share'
      Policies:
        - PolicyName: GrantAccessToAirflowPersistentStorage
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action: 
                  - elasticfilesystem:ClientMount
                  - elasticfilesystem:ClientWrite
                  - elasticfilesystem:DescribeMountTargets
                Resource: !Sub arn:aws:elasticfilesystem:${AvailabilityZone}:${AWSAccountNumber}:file-system/${AirflowPersistantFileSystem}
        - PolicyName: GrantCloudformationListExports
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action: 
                  - cloudformation:ListExports
                Resource: "*"
      RoleName: AirflowIamRoleCloudformation

  AirflowLaunchConfigIamInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties: 
      InstanceProfileName: AirflowIamInstanceProfile
      Roles: 
        - !Ref AirflowEC2Role

  #---------------------- EC2 Launch Config / Autoscaling ----------------------#
  
  # This specifies what gets launched in EC2 as a part of an autoscaling group:
  AirflowLaunchConfiguration:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      AssociatePublicIpAddress: true
      ImageId: !Sub ${LatestEcsAmiId} # Use the latest AWS Linux ECS-Optimised AMI
      InstanceMonitoring: false
      InstanceType: !Sub ${EC2InstanceType}
      IamInstanceProfile: !Ref AirflowLaunchConfigIamInstanceProfile
      KeyName: !Sub ${EC2KeyPairName}
      LaunchConfigurationName: AirflowLaunchConfigCloudformation
      SecurityGroups:
        - !Ref AirflowVPCSecurityGroup
      
  AirflowAutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: AirflowAutoscalingGroupCloudformation
      AvailabilityZones:
        - !Sub ${AvailabilityZone}a
      DesiredCapacity: '1'
      MaxSize: '1'
      MinSize: '0'
      LaunchConfigurationName: !Ref AirflowLaunchConfiguration
      VPCZoneIdentifier:
        - !Ref AirflowVPCSubnet
    DependsOn:
      - AirflowVPCGatewayAttachment
      # - AirflowDatabase

  #---------------------------- ECS (Docker) Resources -------------------------------#
  AirflowECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: airflow-ecs-cluster

  AirflowECRRepository:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: airflow-ecr-repository
      # Only keep up to a certain amount of images in ECR to save on storage costs:
      LifecyclePolicy:
        LifecyclePolicyText: | 
          {
            "rules": [
            {
              "rulePriority": 1,
              "description": "Only keep 3 images",
              "selection": {
                "tagStatus": "any",
                "countType": "imageCountMoreThan",
                "countNumber": 3
              },
              "action": { "type": "expire" }
            }]
          }

  # AirflowECSTask:
  #   Type: AWS::ECS::TaskDefinition
  #   Properties:
  #     Essential: true

Outputs:
  AirflowEfsFilesystemId:
    Description: The ID generated for the EFS volume used for Airflow persisent storage
    Value: !Ref AirflowPersistantFileSystem
    Export:
      Name: AirflowEfsFilesystemId
  # AirflowDatabaseHostname:
  #   Description: The hostname of the RDS instance used for the Airflow backend
  #   Value: !GetAtt AirflowDatabase.Endpoint.Address
